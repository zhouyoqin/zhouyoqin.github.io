(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{a(window.jQuery||window.Zepto)}}(function(a){function b(c,f){this.el=a(c);this.options=f||{};this.options.start=this.options.start||this.el.data("crossfade-start");this.options.end=this.options.end||this.el.data("crossfade-end");if(!this.options.start||!this.options.end){throw new Error("crossfade.js requires two images.")}var g=this.options.backgroundPosition.split(" ");this.options.backgroundPositionX=g[0];this.options.backgroundPositionY=g[1];this.width=this.el.width();this.height=this.el.height();this.canvas=a("<canvas>").css({position:"absolute",top:"0",left:"0",width:this.width,height:this.height});this.canvas.appendTo(this.el);this.paintbrush=this.canvas[0].getContext("2d");var e=a.proxy(this.onScroll,this);var d=a.proxy(this.onResize,this);this.preload(function(){a(window).on("scroll",e).trigger("scroll");a(window).on("resize",d).trigger("resize")})}b.prototype.preload=function(c){var g,f,e;this.start=a("<img>").attr({src:this.options.start});this.end=a("<img>").attr({src:this.options.end});g=[this.start,this.end];f=g.length;e=function(){f--;if(f===0){if(typeof c==="function"){c()}}};for(var d=0;d<g.length;d++){g[d].on("load",e);if(g[d].prop("complete")){g[d].trigger("load")}}};b.prototype.resize=function(){this.needsResize=false;this.canvas[0].width=this.width;this.canvas[0].height=this.height;this.canvas.css({width:this.width,height:this.height})};b.prototype.draw=function(){var c;if(this.needsResize){this.resize()}c=this.getDrawDimensions(this.start[0].width,this.start[0].height,this.width,this.height);this.paintbrush.drawImage(this.start[0],c.offset.x,c.offset.y,c.width,c.height);this.paintbrush.globalAlpha=this.visibility;this.paintbrush.drawImage(this.end[0],c.offset.x,c.offset.y,c.width,c.height);this.paintbrush.globalAlpha=1;this.ticking=false};b.prototype.getDrawDimensions=function(i,g,e,c){var f={};var h=g/i;var d=c/e;if(d>h){f.width=parseInt(c/h);f.height=parseInt(c)}else{f.width=parseInt(e);f.height=parseInt(e*h)}f.offset={};switch(this.options.backgroundPositionY){case"top":f.offset.y=0;break;case"bottom":f.offset.y=(f.height-c)*-1;break;case"center":default:f.offset.y=(f.height-c)/-2;break}switch(this.options.backgroundPositionX){case"left":f.offset.x=0;break;case"right":f.offset.x=(f.width-e)*-1;break;case"center":default:f.offset.x=(f.width-e)/-2;break}return f};b.prototype.onScroll=function(){var f=a(window).scrollTop();var d=this.el.offset().top;var c=this.el.height();var e;if(d>f){e=0}else{if((d+c)<f){e=1}else{e=(f-d)/(c*this.options.threshold)}}this.visibility=e;this.requestTick()};b.prototype.onResize=function(){this.needsResize=true;this.width=this.el.width();this.height=this.el.height();this.requestTick()};b.prototype.requestTick=function(){var c=this;if(!this.ticking){window.requestAnimFrame(function(){c.draw()})}this.ticking=true};a.extend(a.fn,{crossfade:function(c){var d=a.extend({},a.fn.crossfade.defaults,c);return this.each(function(){a(this).data("crossfade",new b(this,d));return this})}});a.fn.crossfade.defaults={backgroundPosition:"center center",threshold:0.5};window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(c){window.setTimeout(c,1000/60)}})()}));